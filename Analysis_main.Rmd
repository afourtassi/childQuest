---
title: "inter-rater"
output: html_document
---
```{r setup, include=FALSE, warning=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(dplyr)
library(tidyr)
library(stringr)
library(boot)
library(purrr)
library(ggplot2)
library(ggthemes)
library(feather)
library(poweRlaw)
library(wordbankr)
#library(rwebppl)
library(lme4)
library(Hmisc)
library(qdapRegex)
library(HDInterval)
library(lmerTest)
library(childesr)
library(brms)
library(stringr)

library(xlsx)
library(irr)

library(readr)

```


```{r}
### dara For Theophile
###################

Theophile <-  read_csv("Annotations-final/Annotation_csv_speaker/Theophile_020020.csv") %>%
  mutate(child = "Theophile",
         age = 2,
         file = "020020") %>%
  
  bind_rows(read_csv("Annotations-final/Annotation_csv_speaker/Theophile_020208.csv") %>%
  mutate(child = "Theophile",
         age = 2,
         file = "020208")) %>%
  
  bind_rows(read_csv("Annotations-final/Annotation_csv_speaker/Theophile_030200.csv") %>%
  mutate(child = "Theophile",
         age = 3,
         file = "030200")) %>%
  
  bind_rows(read_csv("Annotations-final/Annotation_csv_speaker/Theophile_030410.csv") %>%
  mutate(child = "Theophile",
         age = 3,
         file = "030410")) %>%
  
  bind_rows(read_csv("Annotations-final/Annotation_csv_speaker/Theophile_040329.csv") %>%
  mutate(child = "Theophile",
         age = 4,
         file = "040329")) %>%
  
  bind_rows(read_csv("Annotations-final/Annotation_csv_speaker/Theophile_040620.csv") %>%
  mutate(child = "Theophile",
         age = 4,
         file = "040620")) 


### dara For Madeleine
######################

Madeleine <-  read_csv("Annotations-final/Annotation_csv_speaker/Madeleine_020102.csv") %>%
  mutate(child = "Madeleine",
         age = 2,
         file = "020102") %>%
  
  bind_rows(read_csv("Annotations-final/Annotation_csv_speaker/Madeleine_020206.csv") %>%
  mutate(child = "Madeleine",
         age = 2,
         file = "020206")) %>%
  
  bind_rows(read_csv("Annotations-final/Annotation_csv_speaker/Madeleine_030028.csv") %>%
  mutate(child = "Madeleine",
         age = 3,
         file = "030028")) %>%
  
  bind_rows(read_csv("Annotations-final/Annotation_csv_speaker/Madeleine_030302.csv") %>%
  mutate(child = "Madeleine",
         age = 3,
         file = "030302")) %>%
  
   bind_rows(read_csv("Annotations-final/Annotation_csv_speaker/Madeleine_041003.csv") %>%
  mutate(child = "Madeleine",
         age = 4,
         file = "041003")) %>%
  
  bind_rows(read_csv("Annotations-final/Annotation_csv_speaker/Madeleine_050105.csv") %>%
  mutate(child = "Madeleine",
         age = 4,
         file = "050105"))
  
  
### dara For Adrien
######################

Adrien_020222  <-  read_csv("Annotations-final/Annotation_csv_speaker/Adrien_020222.csv") %>%
  mutate(child = "Adrien",
         age = 2,
         file = "020222")
  
Adrien_020328 <-  read_csv("Annotations-final/Annotation_csv_speaker/Adrien_020328_CHI.csv") %>%
  mutate(child = "Adrien",
         age = 2,
         file = "020328") %>%
  filter(`list-ID` == 1) %>%
  bind_rows(read_csv("Annotations-final/Annotation_csv_speaker/Adrien_020328_PAR.csv") %>%
  mutate(child = "Adrien",
         age = 2,
         file = "020328") %>%
    filter(`list-ID` == 2)) 


Adrien_030015 <-  read_csv("Annotations-final/Annotation_csv_speaker/Adrien_030015_CHI.csv") %>%
  mutate(child = "Adrien",
         age = 3,
         file = "030015") %>%
  filter(`list-ID` == 1) %>%
  bind_rows(read_csv("Annotations-final/Annotation_csv_speaker/Adrien_030015_PAR.csv") %>%
  mutate(child = "Adrien",
         age = 3,
         file = "030015") %>%
    filter(`list-ID` == 2)) 


Adrien_030212 <-  read_csv("Annotations-final/Annotation_csv_speaker/Adrien_030212_CHI.csv") %>%
  mutate(child = "Adrien",
         age = 3,
         file = "030212") %>%
  filter(`list-ID` == 1) %>%
  bind_rows(read_csv("Annotations-final/Annotation_csv_speaker/Adrien_030212_PAR.csv") %>%
  mutate(child = "Adrien",
         age = 3,
         file = "030212") %>%
    filter(`list-ID` == 2)) 


Adrien_030909 <-  read_csv("Annotations-final/Annotation_csv_speaker/Adrien_030909_CHI.csv") %>%
  mutate(child = "Adrien",
         age = 4,
         file = "030909") %>%
  filter(`list-ID` == 1) %>%
  bind_rows(read_csv("Annotations-final/Annotation_csv_speaker/Adrien_030909_PAR.csv") %>%
  mutate(child = "Adrien",
         age = 4,
         file = "030909") %>%
    filter(`list-ID` == 2)) 


Adrien_031113 <-  read_csv("Annotations-final/Annotation_csv_speaker/Adrien_031113_CHI.csv") %>%
  mutate(child = "Adrien",
         age = 4,
         file = "031113") %>%
  filter(`list-ID` == 1) %>%
  bind_rows(read_csv("Annotations-final/Annotation_csv_speaker/Adrien_031113_PAR.csv") %>%
  mutate(child = "Adrien",
         age = 4,
         file = "031113") %>%
    filter(`list-ID` == 2)) 

Adrien <- Adrien_020222 %>%
  bind_rows(Adrien_020328) %>%
  bind_rows(Adrien_030015) %>%
  bind_rows(Adrien_030212) %>%
  bind_rows(Adrien_030909) %>%
  bind_rows(Adrien_031113) 


### dara For Anae
##################

Anae_020025 <-  read_csv("Annotations-final/Annotation_csv_speaker/Anae_020025_CHI.csv") %>%
  mutate(child = "Anae",
         age = 2,
         file = "020025") %>%
  filter(`list-ID` == 1) %>%
  bind_rows(read_csv("Annotations-final/Annotation_csv_speaker/Anae_020025_PAR.csv") %>%
  mutate(child = "Anae",
         age = 2,
         file = "020025") %>%
    filter(`list-ID` == 2)) 


Anae_020105 <-  read_csv("Annotations-final/Annotation_csv_speaker/Anae_020105_CHI.csv") %>%
  mutate(child = "Anae",
         age = 2,
         file = "020105") %>%
  filter(`list-ID` == 1) %>%
  bind_rows(read_csv("Annotations-final/Annotation_csv_speaker/Anae_020105_PAR.csv") %>%
  mutate(child = "Anae",
         age = 2,
         file = "020105") %>%
    filter(`list-ID` == 2)) 

Anae_021122  <-  read_csv("Annotations-final/Annotation_csv_speaker/Anae_021122.csv") %>%
  mutate(child = "Anae",
         age = 3,
         file = "021122")

Anae_030522 <-  read_csv("Annotations-final/Annotation_csv_speaker/Anae_030522_CHI.csv") %>%
  mutate(child = "Anae",
         age = 3,
         file = "030522") %>%
  filter(`list-ID` == 1) %>%
  bind_rows(read_csv("Annotations-final/Annotation_csv_speaker/Anae_030522_PAR.csv") %>%
  mutate(child = "Anae",
         age = 3,
         file = "030522") %>%
    filter(`list-ID` == 2))

Anae_031000 <-  read_csv("Annotations-final/Annotation_csv_speaker/Anae_031000_CHI.csv") %>%
  mutate(child = "Anae",
         age = 4,
         file = "031000") %>%
  filter(`list-ID` == 1) %>%
  bind_rows(read_csv("Annotations-final/Annotation_csv_speaker/Anae_031000_PAR.csv") %>%
  mutate(child = "Anae",
         age = 4,
         file = "031000") %>%
    filter(`list-ID` == 2))

Anae_040012  <-  read_csv("Annotations-final/Annotation_csv_speaker/Anae_040012.csv") %>%
  mutate(child = "Anae",
         age = 4,
         file = "040012")

Anae_040523 <-  read_csv("Annotations-final/Annotation_csv_speaker/Anae_040523_CHI.csv") %>%
  mutate(child = "Anae",
         age = 4,
         file = "040523") %>%
  filter(`list-ID` == 1) %>%
  bind_rows(read_csv("Annotations-final/Annotation_csv_speaker/Anae_040523_PAR.csv") %>%
  mutate(child = "Anae",
         age = 4,
         file = "040523") %>%
    filter(`list-ID` == 2))


Anae <- Anae_020025 %>%
  bind_rows(Anae_020105) %>%
  bind_rows(Anae_021122) %>%
  bind_rows(Anae_030522) %>%
  bind_rows(Anae_031000) %>%
  bind_rows(Anae_040012) %>%
  bind_rows(Anae_040523) 


###ALL DATA:

data <- Anae %>%
  bind_rows(Adrien) %>%
  bind_rows(Madeleine) %>%
  bind_rows(Theophile)


#Date
convertDate  <- function(dateString) {
  y = as.numeric(substr(dateString, 1, 2))
  m = as.numeric(substr(dateString, 3, 4))
  d = as.numeric(substr(dateString, 5, 6))
  mydate <- y*365 + m *30 + d
  mydate <- round(mydate/365,1)
  return(mydate)
}
```


```{r}
#numner of turns by speaker by file
data_turns <-  data %>%
  rename(listID = `list-ID`) %>%
  group_by(listID, child, age, file, Speaker) %>%
  summarise(N_turns = n()) %>%
  ungroup()

data_turns_sum <- data_turns %>%
  filter(listID == 1) %>% # number are same in both list
  mutate(Role = if_else(Speaker =='FAT' | Speaker =='MOT', 'PAR', if_else(Speaker =='CHI', 'CHI', 'OTHER'))) %>%
  group_by(child, age, Role) %>%
  summarise(Turns_avg = mean(N_turns)) %>%
  ungroup() 
            
ggplot(data_turns_sum,  aes(age, Turns_avg, col= Role))+
  geom_line()+
  theme_few()+
  theme(aspect.ratio = 0.7, 
        axis.text=element_text(size=7, angle = 45),
        strip.text.x = element_text(size=7),
        strip.text.y = element_text(size=6)
        ) +
  xlab("Age") +ylab("Turns") +
  facet_grid(.~child, scales= "free_y")
```

Process data 
```{r}

number_turns <-  data %>%
  rename(listID = `list-ID`) %>%
  mutate(Role = if_else(Speaker =='FAT' | Speaker =='MOT', 'PAR', if_else(Speaker =='CHI', 'CHI', 'OTHER'))) %>%
  group_by(listID, child, age, file, Role) %>%
  summarise(N_turns = n()) %>%
  ungroup() %>%
  filter(listID == "1")%>%
  select(-listID) #it's the same number in both
  

data_processed <- data %>%
  rename(listID = `list-ID`) %>%
  mutate(Role = if_else(Speaker =='FAT' | Speaker =='MOT', 'PAR', if_else(Speaker =='CHI', 'CHI', 'OTHER'))) %>%
  #left_join(number_turns) %>%
  filter(annotation != "[NULL,NULL,NULL]") %>%
  #group_by(listID, child, age, file, N_turns, Role) %>%
  rowwise() %>% 
  mutate(lab1 = str_remove(str_remove(unlist(strsplit(annotation, ',')),"\\["), "]")[1], 
         lab2 = str_remove(str_remove(unlist(strsplit(annotation, ',')),"\\["), "]")[2],
         lab3 = str_remove(str_remove(unlist(strsplit(annotation, ',')),"\\["), "]")[3]
         ) %>%
  #ungroup() %>%
  #here make each lable in separate line
  gather(label_number, label_full, lab1, lab2, lab3) %>%
  rowwise() %>% 
  mutate(label = unlist(strsplit(label_full, ':'))[1],
         label_type = unlist(strsplit(label_full, ':'))[2] ,
         label_subtype = unlist(strsplit(label_full, ':'))[3]
         ) %>%
  mutate(Role_annot = unlist(strsplit(label, '-'))[1]) %>%
  select(-label_full, -annotation) %>%
  filter(label != 'NULL')
```


Question
```{r}
questions<- data_processed %>%
  filter(Role != "OTHER") %>%
  filter(label == 'CHI-Initiation' | label == 'PAR-Initiation') %>%
  mutate(Role_annot = unlist(strsplit(label, '-'))[1] ) %>% # We do this because sometimes we annotate an upcoming of the interlocutor within the curreny turn with (e.g.,response:no-response)
  group_by(child, file, Role_annot) %>% 
  summarise(quest_per_file = n()) %>%
  ungroup() %>%
  dplyr::rename(Role = Role_annot) %>%
  left_join(number_turns %>% filter(Role != "OTHER")) %>%
  mutate(quest_per_turn  = quest_per_file/N_turns) %>%
  rowwise() %>%
  mutate(age2 = convertDate(file)) #%>%
  #gather(measure, value,  quest_per_file, quest_per_turn)

ggplot(questions,  aes(age2, quest_per_turn, col= child ))+
  geom_point()+
  geom_smooth(method = lm, se = FALSE)+
  theme_few()+
  theme(aspect.ratio = 0.7, 
        axis.text=element_text(size=7, angle = 45),
        strip.text.x = element_text(size=7),
        strip.text.y = element_text(size=6)
        ) +
  xlab("Age") +ylab("Questions / turn") +
  facet_grid(.~Role, scales= "free_y")

#Model 

model_quest_par <- lmer(formula = quest_per_turn ~ age2  +  (1 | child), 
             data = questions %>% filter(Role == "PAR"))

model_quest_chi <- lmer(formula = quest_per_turn ~ age2  +  (1 | child), 
             data = questions %>% filter(Role == "CHI"))

```
Question categoris 
```{r}

question_types <- data_processed %>%
  filter(Role != "OTHER") %>%
  filter(label == 'CHI-Initiation' | label == 'PAR-Initiation') %>%
  mutate(Role_annot = unlist(strsplit(label, '-'))[1] ) %>%
  group_by(child, file, Role_annot,  label, label_type, label_subtype) %>%
  summarise(quest_type = n()) %>%
  ungroup() %>%
  dplyr::rename(Role = Role_annot) %>%
  left_join(questions) %>%
  mutate(type = if_else(!is.na(label_subtype),label_subtype, label_type)) %>%
  mutate(type_per_total_quest = quest_type/quest_per_file,
         type_per_total_turn = quest_type/N_turns) %>%
  mutate(type= tolower(type)) %>%
  mutate(type= if_else(type == "explanation-seeking", "explanation-based", type))%>%
  mutate(type= if_else(type == "fact-based ", "fact-based", type))
  

ggplot(question_types %>% filter(quest_per_file > 1),  aes(age2, type_per_total_quest, col= type))+
  geom_point()+
  geom_smooth(method = lm, se = FALSE)+
  theme_few()+
  theme(aspect.ratio = 0.7, 
        axis.text=element_text(size=7, angle = 45),
        strip.text.x = element_text(size=7),
        strip.text.y = element_text(size=6)
        ) +
  xlab("Age") +ylab("Type / Total questions") +
  facet_grid(.~Role, scales= "free_y")

question_types %>% filter(quest_per_file > 1)  %>%
  filter(Role == "CHI") %>%
  filter(type == "explanation-based")

```

Responses

```{r}
response_types <- data_processed %>%
  filter(Role != "OTHER") %>%
  filter(label == 'CHI-Response' | label == 'PAR-Response') %>%
  #filter(label_type != 'No-label') %>% # What does "No-lable" mean
  mutate(Role_annot = unlist(strsplit(label, '-'))[1] ) %>%
  group_by(child, file, Role_annot, label, label_type) %>%
  summarise(type_per_file = n()) %>%
  ungroup() %>%
  mutate(res_broad = if_else(label_type == "No-response", "No-response", "Response")) %>%
  group_by(child, file, Role_annot, label) %>%
  mutate(res_total = sum(type_per_file)) %>%
  ungroup() %>%
  group_by(child, file, Role_annot, res_broad) %>%
  mutate(value_res_broad = sum(type_per_file)) %>%
  ungroup() %>%
  dplyr::rename(Role = Role_annot) %>%
  left_join(number_turns %>% filter(Role != "OTHER")) %>%
  rowwise() %>%
  mutate(age2 = convertDate(file)) %>%
  mutate( resp_per_file = res_total/N_turns,
          type_per_total_resp = type_per_file/res_total,
          type_per_total_turn = type_per_file/N_turns,
          broad_per_total_resp = value_res_broad/res_total,
          broad_per_total_turn = value_res_broad/N_turns) #%>%
  #gather(measure, value, type_per_total_resp, type_per_tot#al_turn,broad_per_total_resp, broad_per_total_turn)
```

The percent of repsonses (and no responses) from all turns

```{r}
#Graph total

ggplot(response_types ,  
       aes(age2, broad_per_total_turn , col= res_broad))+
  geom_point()+
  geom_smooth(method = lm, se = FALSE)+
  theme_few()+
  theme(aspect.ratio = 0.7, 
        axis.text=element_text(size=7, angle = 45),
        strip.text.x = element_text(size=7),
        strip.text.y = element_text(size=6)
        ) +
  xlab("Age") +ylab("% out of all turns") +
  facet_grid(.~Role, scales= "free_y")


```

The percent of repsonses from all response opportunities 
(response opportunities  = responses + no-responses)
Note that "response" does not necessarily mean this response is contingent
```{r}
#Graph borad 

data_res_broad <- response_types %>%
         filter(res_broad == 'Response')
                
ggplot(data_res_broad, aes(age2, broad_per_total_resp))+
  geom_point()+
  geom_smooth(method = lm, se = FALSE, size = 0.3)+
  theme_few()+
  theme(aspect.ratio = 0.7, 
        axis.text=element_text(size=7, angle = 45),
        strip.text.x = element_text(size=7),
        strip.text.y = element_text(size=6)
        ) +
  xlab("Age") +ylab("% of responses out of total opportunities") +
  facet_grid(.~Role, scales= "free_y")

model_res_par <- lmer(formula = broad_per_total_resp ~ age2  +  (1 | child), 
             data = data_res_broad %>% filter(Role == "PAR"))

model_res_chi <- lmer(formula = broad_per_total_resp ~ age2  +  (1 | child), 
             data = data_res_broad %>% filter(Role == "CHI"))


```

```{r}
ggplot(data_res_broad, aes(age2, broad_per_total_resp, col = child))+
  geom_point()+
  geom_smooth(method = lm, se = FALSE, size = 0.3)+
  theme_few()+
  theme(aspect.ratio = 0.7, 
        axis.text=element_text(size=7, angle = 45),
        strip.text.x = element_text(size=7),
        strip.text.y = element_text(size=6)
        ) +
  xlab("Age") +ylab("% of responses out of total opportunities") +
  facet_grid(.~Role, scales= "free_y")

```

Contingency
```{r}

response_contingent <-  response_types %>%
  filter(label_type != "No-response") %>% 
  mutate(resp_cont = type_per_file/value_res_broad) %>%
  mutate(label_type = if_else(label_type== "Answer", "Contingent", if_else(label_type== "Non-answer", "Non-contingent", label_type)))

ggplot(response_contingent,  
       aes(age2, resp_cont , col= label_type))+
  geom_point()+
  geom_smooth(method = lm, se = FALSE)+
  theme_few()+
  theme(aspect.ratio = 0.7, 
        axis.text=element_text(size=7, angle = 45),
        strip.text.x = element_text(size=7),
        strip.text.y = element_text(size=6)
        ) +
  xlab("Age") +ylab("% out of total responses") +
  facet_grid(.~Role, scales= "free_y")

```
What are Contingent response made of ?

```{r}

```



```{r}
questions_sum <- questions %>%
  group_by(age, Role, measure) %>%
  summarise(mean = mean(value))

 summarise(quest_total = sum(N_questions),
            files_total = n(),
            turn_total = sum(N_turns)) %>%
  ungroup() %>%
  mutate(quest_per_file = quest_total/files_total,
         quest_per_turn = quest_total/turn_total) %>%
  gather(measure, value,  quest_per_file, quest_per_turn)

ggplot(questions_sum,  aes(age, mean, col= Role))+
  geom_line()+
  #geom_text(data = child_adult_questions, aes(age, label=child), size = 2.5)+
  geom_point(data = questions, aes(age, value))+ 
  theme_few()+
  theme(aspect.ratio = 0.7, 
        axis.text=element_text(size=7, angle = 45),
        strip.text.x = element_text(size=7),
        strip.text.y = element_text(size=6)) +
  xlab("Age") +ylab("Question") +
  facet_grid(measure~., scales= "free")

```


```{r}


#Date
convertDate  <- function(dateString) {
  y = as.numeric(substr(dateString, 1, 2))
  m = as.numeric(substr(dateString, 3, 4))
  d = as.numeric(substr(dateString, 5, 6))
  mydate <- y*365 + m *30 + d
  mydate <- round(mydate/365, 1)
  return(mydate)
}

#Number of question out of all utterances by the speaker 
questions_by_file_over_total <- data %>%
  rename(listID = `list-ID`) %>%
  #filter(turn == 'Initiation') %>%
  #filter(speaker!='Complex') %>%
  #mutate(Speaker2 = if_else(Speaker =="MOT" | Speaker =="FAT", "PAR", Speaker)) %>% 
  #filter(Speaker2 !="OBS", 
  #       Speaker2 !="INV",
  #       Speaker2 !="COM") %>%
  #select(-Speaker) %>%
  #dplyr::rename(speaker = Speaker2) %>%
  group_by(listID, child, age, file, Speaker) %>%
  summarise(N = n()) %>%
  ungroup() %>%
  group_by(myID, child, age, speaker) %>%
  summarise(N_tot = sum(N),
            n_files = n()) %>%
  mutate(N_avg = N_tot/n_files) %>%
  



ggplot(questions_by_file,  aes(age, N_avg, col= speaker))+
  geom_line()+
  
  theme_few()+
  theme(aspect.ratio = 0.7, 
        axis.text=element_text(size=7, angle = 45),
        strip.text.x = element_text(size=7),
        strip.text.y = element_text(size=6)
        ) +
  xlab("Age") +ylab("Questio") +
  facet_grid(.~child, scales= "free_y") 


child_adult_questions_sum <- questions_by_file_over_total  %>%
  group_by(myID, age, speaker) %>%
  summarise(mean = mean(N_avg))


ggplot(questions_by_file_over_total,  aes(age, mean, col= speaker))+
  geom_line()+
  #geom_text(data = child_adult_questions, aes(age, label=child), size = 2.5)+
  geom_point(data = child_adult_questions, aes(age, N_avg))+ 
  theme_few()+
  theme(aspect.ratio = 0.7, 
        axis.text=element_text(size=7, angle = 45),
        strip.text.x = element_text(size=7),
        strip.text.y = element_text(size=6)) +
  xlab("Age") +ylab("Questio") +
  facet_grid(.~child, scales= "free_y") 
```


```{r}
xlab("Age") +ylab("Questions") #+
  #facet_grid(.~child, scales= "free_y") 


```

